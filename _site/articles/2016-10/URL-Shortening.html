<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="msvalidate.01" content="23FC806069D5C2D348A94A2A7E7FAE88" />

  <title>URL Shortening</title>
  <meta name="description" content="Short and sweet :)">

  <!-- CSS files -->
  <link rel="stylesheet" href="https://anandjoshi.me/css/font-awesome.min.css">
  <link rel="stylesheet" href="https://anandjoshi.me/css/main.css">

  <link rel="canonical" href="https://anandjoshi.me/articles/2016-10/URL-Shortening">
  <link rel="alternate" type="application/rss+xml" title="Anand" href="https://anandjoshi.me/feed.xml" />

  <!-- Icons -->
  <!-- 16x16 -->
  <link rel="shortcut icon" href="https://anandjoshi.me/favicon.ico">
  <!-- 32x32 -->
  <link rel="shortcut icon" href="https://anandjoshi.me/favicon.png">
</head>


<!--

############################## Hello Hacker ########################################################

Hi Hacker ! Looks like you're more curious about my code than my articles :P
That's perfectly fine. I too, like inspecting websites. This blog is set up
using jekyll, again I have an article for that if you would like to know more.
Now avoid yourself the trouble of using these browser developer tools to analyse my website.
I have made things simpler, you can find the entire source code 
of my website here : https://github.com/anandjoshi91/anandjoshi91.github.io

Feel free to get in touch with me. I would love to hear your crazy ideas :)

Happy Coding \m/

############################## Hello Hacker ########################################################

-->

<body>
  <div class="row">
    <div class="col s12 m3">
      <div class="table cover">
        

<div class="cover-card table-cell table-middle">
  
  <a href="https://anandjoshi.me/" class="author_name"></a>
  <span class="author_job"></span>
  <span class="author_bio mbm"></span>
  <nav class="nav">
    <ul class="nav-list">
      <li class="nav-item">
        <a href="https://anandjoshi.me/">home</a>
        <span>/</span>
      </li>
           
      <li class="nav-item">
        <a href="https://anandjoshi.me/about/">About</a>
        
          <span>/</span>
        
      </li>
        
      <li class="nav-item">
        <a href="https://anandjoshi.me/tags/">Tags</a>
        
          <span>/</span>
        
      </li>
          
      <li class="nav-item">
        <a href="https://anandjoshi.me/categories/">Categories</a>
        
          <span>/</span>
        
      </li>
          
      <li class="nav-item">
        <a href="https://anandjoshi.me/archive/">Archive</a>
        
          <span>/</span>
        
      </li>
                   
    </ul>
  </nav>
  <script type="text/javascript">
  // based on http://stackoverflow.com/a/10300743/280842
  function gen_mail_to_link(hs, subject) {
    var lhs,rhs;
    var p = hs.split('@');
    lhs = p[0];
    rhs = p[1];
    document.write("<a class=\"social-link-item\" target=\"_blank\" href=\"mailto");
    document.write(":" + lhs + "@");
    document.write(rhs + "?subject=" + subject + "\"><i class=\"fa fa-fw fa-envelope\"></i><\/a>");
  }
</script>
<div class="social-links">
  <ul>
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
  </ul>
</div>

</div>

      </div>
    </div>
    <div class="col s12 m9">
      <div class="post-listing">
        <a class="btn" href= "https://anandjoshi.me/" >
  Home
</a>

<div class="post-image-feature">
  <img class="feature-image" src=
  
  "https://anandjoshi.me/img/turn-long-short.jpg"
  
  alt="URL Shortening feature image">

  
</div><!-- /.image-wrap -->



<div id="post">
  <header class="post-header">
    <h1 title="URL Shortening">URL Shortening</h1>
    <span class="post-meta">
      <span class="post-date">
        22 OCT 2016
      </span>
      â€¢
      <span class="read-time" title="Estimated read time">
  
  
    5 mins read
  
</span>

    </span>

  </header>

  <article class="post-content">
    <h2 id="url-shorteners-">URL Shorteners :</h2>
<p>Well, so you are tweeting about this amazing video which you think would be a big hit on the social media.
You open your twitter account, copy the URL and paste it to tweet, but wait ! The URL itself is 140+ characters, let alone your quirky comments.</p>

<p>And then you hear about these amazing tools called - URL Shorteners. They convert the dirty looking urls into short, sweet and slick urls, which can not only be easily shared on twitter and other media but they also provide you a hell lot of analytics and user information.</p>

<p><strong>Here are some commonly used URL shorteners :</strong></p>
<ol>
  <li><a href="https://bitly.com/" target="_blank">bit.ly</a></li>
  <li><a href="https://goo.gl/" target="_blank">goo.gl</a></li>
  <li><a href="http://ow.ly/url/shorten-url" target="_blank">ow.ly</a></li>
</ol>

<h2 id="well-but-how-does-url-shortening-work-">Well, but how does URL shortening work ?</h2>

<p><img src="/img/url-short.jpg" alt="url-shortening" /></p>

<p>Let us paraphrase what URL shortening tools do. They convert a long arbitrary length of string into a short and compact combination of characters, which has much smaller length than the original URL. So if we understand this, we
also understand that essentially these tools are just mapping one set to another, but where one set is very large, probably infinite where as the other is a smaller and finite set. Does this sound a bit familiar to the computer science guys ? Yes this is <code class="highlighter-rouge">Hashing</code> ! It has wide usage from designing a HashMap, Lookup tables to creating a md5 hash for cryptographic purpose.</p>

<p><img src="/img/hashing.PNG" alt="hashing" /></p>

<h2 id="but-why-hash-when-you-can-use-random-short-strings-">But why hash when you can use random short strings ?</h2>

<p>Yes. This is a valid approach. The original long url would be mapped to a short sequence of random strings. One reason where hashing would have advantage over random strings is, if for some reason my database crashes and I do not have a backup then I would not be able to recover the short url even if I managed to pull the old long url (say from some other user account data, app logs etc). Hashing will guarantee me that it will reproduce the same old short url for the original url. Just a design perspective we might consider while building this app.</p>

<h2 id="a-demo-project">A demo project</h2>

<p>Let us create a small <code class="highlighter-rouge">django project</code> to uderstand how URL shortening work.
You may fork my project <a href="https://github.com/anandjoshi91/url-shortener" target="_blank">url-shortener</a>  from the GitHub.</p>

<p>After forking the above repo, change the log path in <code class="highlighter-rouge">shorturl/settings.py</code> and run the application by typing the following command</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>python manage.py runserver
</code></pre></div></div>

<p>This will create the <code class="highlighter-rouge">shorturl/db.sqlite3</code> file. After this run the DB migrations to create the required tables by using the following command.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>python manage.py migrate
</code></pre></div></div>

<h3 id="this-is-how-the-home-page-looks">This is how the home page looks.</h3>

<p><img src="/img/url-shortener-home.PNG" alt="url-shortener-home" /></p>

<h3 id="compact-url-after-shortening-it">Compact URL after shortening it.</h3>
<p><img src="/img/url-shorten.PNG" alt="url-shorten" /></p>

<p>The heart of the project is to understand how to write a good <a href="http://www.eternallyconfuzzled.com/tuts/algorithms/jsw_tut_hashing.aspx" target="_blank">Hashing function.</a></p>

<p>Let us look at the the <strong><em>model.py</em></strong> inside the smallify app in the above project.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">URL</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">original_url</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">unique</span><span class="o">=</span> <span class="bp">True</span><span class="p">)</span>
    <span class="n">shortened_url</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">unique</span> <span class="o">=</span>  <span class="bp">True</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">shorten_url</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shortened_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__fnv_hash</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">original_url</span><span class="p">)</span>
        
        <span class="k">if</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shortened_url</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">original_url</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">shortened_url</span> <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">original_url</span>
        
        
    <span class="o">@</span><span class="nb">staticmethod</span>
    <span class="k">def</span> <span class="nf">__fnv_hash</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>
        <span class="n">h</span> <span class="o">=</span> <span class="mi">2166136261</span>
        
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">key</span><span class="p">:</span>
            <span class="n">h</span> <span class="o">=</span> <span class="p">(</span><span class="n">h</span><span class="o">*</span><span class="mi">16777619</span><span class="p">)</span><span class="o">^</span><span class="nb">ord</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
        
        <span class="c1"># Return 8 bit URL
</span>        <span class="k">return</span> <span class="n">base64</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">h</span><span class="o">%</span><span class="mi">281474976710656</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="o">.</span><span class="n">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>  
</code></pre></div></div>

<p>It makes use of the <a href="http://www.isthe.com/chongo/tech/comp/fnv/" target="_blank">FNV hashing algorithm</a>.
Look at the private method <code class="highlighter-rouge">__fnv_hash</code> in the above code snippet. It converts an arbitary length of string <em>key</em> into a 8 bit URL. Here every character of the key (original url) is XORed with a random integer <strong>h</strong> which is also multiplied at each stage to get a good folding effect. XORing gives a good uniform distribution. After this we encode the  given integer to <a href="https://en.wikipedia.org/wiki/Base64" target="_blank">base64</a>. Like a binary base has only 2 digits to represent every possible number, base64 uses 64 different characters. This gives us a more compact representation of the integer <strong>h</strong>. Finally, we do modular division by <em>(281474976710655 + 1)</em> to get a 8 bit compact URL.</p>

<h3 id="why-281474976710656-">Why 281474976710656 ?</h3>

<p>As we can see from the below commands, the 64th character (starts with 0 to 63) is an underscore <code class="highlighter-rouge">" _ "</code>. So the value of 8 consecutive <code class="highlighter-rouge">" _ "</code> is 281474976710655 and hence we do a modular division with (281474976710655 + 1)</p>

<p><img src="/img/encoding-url-shortener.PNG" alt="encoding-url-shortener" /></p>

<p class="notice">With this, we have some basic understanding of URL Shorteners. The demo project <a href="https://github.com/anandjoshi91/url-shortener" target="_blank">url-shortener</a> in quite naive and created for this tutorial. Do check it out and let me know if you have any improvements in it. Feel free to send a pull request and looking forward to your views, opinions, and tips in the comments below.</p>

  </article>
</div>

<div class="share-buttons">
  <h6>Share on: </h6>
  <ul>
    <li>
      <a href="https://twitter.com/intent/tweet?text=https://anandjoshi.me/articles/2016-10/URL-Shortening" class="twitter btn" title="Share on Twitter"><i class="fa fa-twitter"></i><span> Twitter</span></a>
    </li>
    <li>
      <a href="https://www.facebook.com/sharer/sharer.php?u=https://anandjoshi.me/articles/2016-10/URL-Shortening" class="facebook btn" title="Share on Facebook"><i class="fa fa-facebook"></i><span> Facebook</span></a>
    </li>
    <li>
      <a href="https://plus.google.com/share?url=https://anandjoshi.me/articles/2016-10/URL-Shortening" class="google-plus btn" title="Share on Google Plus"><i class="fa fa-google-plus"></i><span> Google+</span></a>
    </li>
    <li>
      <a href="https://news.ycombinator.com/submitlink?u=https://anandjoshi.me/articles/2016-10/URL-Shortening" class="hacker-news btn" title="Share on Hacker News"><i class="fa fa-hacker-news"></i><span> Hacker News</span></a>
    </li>
    <li>
      <a href="https://www.reddit.com/submit?url=https://anandjoshi.me/articles/2016-10/URL-Shortening" class="reddit btn" title="Share on Reddit"><i class="fa fa-reddit"></i><span> Reddit</span></a>
    </li>
  </ul>
</div><!-- end share-buttons -->

<nav class="post-navigation" role="navigation">
  <div class="row">
    <div class="col s5">
      <div class="post-nav-prev">
        
        <a href="https://anandjoshi.me/articles/2016-10/Blogging-with-github-and-jekyll" title="Blogging with Jekyll and GitHub">
          <div class="post-nav-btn">
            <div class="post-nav-text"><span class="success-text-color"><i class="fa fa-arrow-left" aria-hidden="true"></i> </span><span class="hidden-md primary-text-color">Blogging with Jekyll and GitHub</span></div>
          </div>
        </a>
        
      </div>
    </div>
    <div class="col s2">
      <a href="https://anandjoshi.me/">
        <div class="leonids-icon">
          <i class="fa fa-home" aria-hidden="true"></i>
        </div>
      </a>
    </div>
    <div class="col s5 right">
      <div class="post-nav-next">
        
        <a href="https://anandjoshi.me/articles/2016-11/An-Old-Letter" title="Blogging with Jekyll and GitHub">
          <div class="post-nav-btn">
            <div class="post-nav-text"><span class="hidden-md primary-text-color">An Old Letter</span><span class="success-text-color"> <i class="fa fa-arrow-right" aria-hidden="true"></i></i></span></div>
          </div>
        </a>
        
      </div>
    </div>
  </div>
</nav>

<div class="col-sm-3">
	<div id="search" align="center" style="margin-top:20px;">
	  <form role="search" method="get" action="/search/" class="form-inline">
	     <div class="form-group">
	       <input style="height:36px;font-size:12pt;width: 100%"; id="searchString" name="searchString"
	              placeholder="Search for articles/posts/songs/projects..." type="text"><br/>
	       <input style="width: 100%" class="btn" id="searchButton" name="googleSearchName" type="submit" value="Search">
	     </div>  
	  </form>
	</div>
</div>
 <div class="col-sm-3">
    <!-- Begin MailChimp Signup Form -->
    <link href="//cdn-images.mailchimp.com/embedcode/horizontal-slim-10_7.css" rel="stylesheet" type="text/css">
    <style type="text/css">
    	#mc_embed_signup{background:#fff; clear:left; font:14px Helvetica,Arial,sans-serif; width:100%;}
    	/* Add your own MailChimp form style overrides in your site stylesheet or in this style block.
    	   We recommend moving this block and the preceding CSS link to the HEAD of your HTML file. */
    </style>
    <div id="mc_embed_signup">
    <form action="//anandjoshi.us14.list-manage.com/subscribe/post?u=be458ebda1fb81a6e8927336c&amp;id=a3d66d381e" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate>
        <div id="mc_embed_signup_scroll">
    	<label for="mce-EMAIL"></label>
    	<input style="width: 100%" type="email" value="" name="EMAIL" class="email" id="mce-EMAIL" placeholder="email address" required>
        <!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups-->
        <div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_be458ebda1fb81a6e8927336c_a3d66d381e" tabindex="-1" value=""></div>
        <br/>
        <input style="width: 100%" type="submit" value="Subscribe" name="subscribe" id="mc-embedded-subscribe" class="btn btn-info">
        </div>
    </form>
    </div>
</div>
    <!--End mc_embed_signup-->




<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES * * */
    var disqus_shortname = 'disqus-xhnqvb9w3g';

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>






        <footer class="notice" style="margin-bottom:5px;margin-top:15px;">
  &copy; 2019 Anand Joshi. Listen to your <i class="fa fa-heart heart-icon"></i>
</footer>

      </div>
    </div>
  </div>
  <script type="text/javascript" src="https://anandjoshi.me/js/jquery-2.1.4.min.js"></script>
<script type="text/javascript" src="https://anandjoshi.me/js/main.js"></script>

<!-- Asynchronous Google Analytics snippet -->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-85824802-1', 'auto');
  ga('send', 'pageview');
</script>


</body>
</html>
